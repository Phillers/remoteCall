/*
 * This is sample code generated by rpcgen.
 * These are only templates and you can use them
 * as a guideline for developing your own functions.
 */

#include "remoteCall.h"
#include "callBack.h"
#include <unistd.h>
#include <arpa/inet.h>
#include <sys/wait.h>

int inpipe[2];
int outpipe[2];
int errpipe[2];
char g_data[1024];

void *
callcommand_1_svc(char *command,  struct svc_req *rqstp)
{
	static char * result;

	/*
	 * insert server code here
	 */
	int res;
	pipe(inpipe);
	printf("call %s\n", command);
	if(fork()==0){
		close(inpipe[1]);
		pipe(outpipe);
		pipe(errpipe);
		int pid;
		if((pid = fork()>0)){
			close(outpipe[0]);
			close(errpipe[0]);
			int save_out = dup(1);
			int save_err = dup(2);
			int save_in = dup(0);
			dup2(outpipe[1],1);
			dup2(errpipe[1],2);
			dup2(inpipe[0],0);
			res = system(command);
			close(outpipe[1]);
			dup2(save_out, 1);
			close(errpipe[1]);
			dup2(save_err, 2);
			close(inpipe[1]);
			dup2(save_in, 0);
		}else{
			close(inpipe[0]);
			close(outpipe[1]);
			close(errpipe[1]);
			if(fork()>0) {
				close(errpipe[0]);
				char buffer[1025];
				memset(buffer, 0, 1025);
				int bytes;
				while ((bytes = read(outpipe[0], buffer, 1024)) > 0) {
					callback_1_clnt(inet_ntoa(rqstp->rq_xprt->xp_raddr.sin_addr), 10, buffer, 1, bytes);
					memset(buffer, 0, 1025);
				}
				close(outpipe[0]);
				wait(NULL);
				exit(0);
			} else{
				close(outpipe[0]);
				char buffer[1025];
				memset(buffer, 0, 1025);
				int bytes;
				while ((bytes = read(errpipe[0], buffer, 1024)) > 0) {
					callback_1_clnt(inet_ntoa(rqstp->rq_xprt->xp_raddr.sin_addr), 10, buffer, 2, bytes);
					memset(buffer, 0, 1025);
				}
				close(errpipe[0]);
				exit(0);
			}
		}
		int status;
		wait(&status);
		if(WIFEXITED(res))status=WEXITSTATUS(res);
		else status = res;
		callback_1_clnt(inet_ntoa(rqstp->rq_xprt->xp_raddr.sin_addr), status, "", -1, 0);
		printf("res %x, data: %s\n", res, g_data);
		exit(0);
	}
	close(inpipe[0]);
	return (void *) &result;
}

void *
senddata_1_svc(char *data, int size,  struct svc_req *rqstp)
{
	if(size>0){
		write(inpipe[1], data, size);
		write(1, data, size);
	} else {
		close(inpipe[1]);
	}
	static char * result;
	/*
	 * insert server code here
	 */


	return (void *) &result;
}
